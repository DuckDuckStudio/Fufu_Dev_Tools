name: åŒæ­¥ä¸»ä»“åº“çš„ LICENSE æ–‡ä»¶

on:
  workflow_dispatch:
  # ç›‘å¬ä¸»ä»“åº“ä¸­çš„ä¿®æ”¹é€šçŸ¥
  repository_dispatch:
    types: [license-update]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync_license:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºå¼€å‘å·¥å…·ä»“åº“ä»£ç 
        uses: actions/checkout@v5.0.1

      - name: è·å–æœ€æ–°è®¸å¯æ–‡ä»¶å¹¶æ¯”è¾ƒ
        run: |
          # å…‹éš†ä¸»ä»“åº“å¹¶è·å– LICENSE æ–‡ä»¶
          git clone --branch main https://github.com/DuckDuckStudio/Fufu_Tools.git Fufu_Tools
          
          # æ¯”è¾ƒå½“å‰ä»“åº“å’Œä¸»ä»“åº“çš„ LICENSE æ–‡ä»¶æ˜¯å¦ç›¸åŒ
          if (Compare-Object (Get-Content LICENSE) (Get-Content Fufu_Tools/LICENSE)) {
            Write-Host "[WARNING] å½“å‰ä»“åº“ä¸­çš„è®¸å¯æ–‡ä»¶å·²ç»è¿‡æ—¶ï¼Œéœ€è¦æ›´æ–°ã€‚"
            echo "up-to-date=false" >> $env:GITHUB_ENV
            # å°†ä¸»ä»“åº“çš„è®¸å¯æ–‡ä»¶æ‹·è´åˆ°å½“å‰ä»“åº“æ›¿æ¢æ—§çš„è®¸å¯æ–‡ä»¶
            Copy-Item Fufu_Tools/LICENSE LICENSE -Force
            Remove-Item -Recurse Fufu_Tools -Force
      
            # è½¬æ¢ç¼–ç ï¼šå°† LICENSE æ–‡ä»¶ä» UTF-8 è½¬æ¢ä¸º GBK ç¼–ç 
            $content = Get-Content LICENSE -Raw
            $content | Out-File LICENSE-GBK -Encoding "gb2312"
          } else {
            Write-Host "ğŸ‰ å½“å‰ä»“åº“ä¸­çš„è®¸å¯æ–‡ä»¶å·²ç»æœ€æ–°ï¼Œæ— éœ€æ›´æ–°ã€‚"
            echo "up-to-date=true" >> $env:GITHUB_ENV
          }

      - name: è·å–æ–°çš„ LICENSE æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·
        if: env.up-to-date == 'false'
        run: |
          # ä»è®¸å¯æ–‡ä»¶ä¸­è·å–ç‰ˆæœ¬å·
          $version = Select-String -Pattern 'v[0-9]+\.[0-9]+\.[0-9]+' LICENSE | ForEach-Object { $_.Matches.Groups[0].Value }
          echo "LICENSE_VERSION=${version}" >> $env:GITHUB_ENV

      - name: æ¨é€ä¿®æ”¹
        if: env.up-to-date == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -b "LICENSE-${{ env.LICENSE_VERSION }}"

          git add LICENSE
          git add LICENSE-GBK
          git commit -m "[Auto] æ›´æ–°è®¸å¯æ–‡ä»¶è‡³ç‰ˆæœ¬ ${version}"

          git push origin "LICENSE-${{ env.LICENSE_VERSION }}" --force

      - name: åˆ›å»ºæ‹‰å–è¯·æ±‚
        if: env.up-to-date == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # åˆ›å»ºæ‹‰å–è¯·æ±‚
          gh pr create --title "[Auto] æ›´æ–°è®¸å¯æ–‡ä»¶è‡³ç‰ˆæœ¬ ${{ env.LICENSE_VERSION }}" --body "æ­¤æ‹‰å–è¯·æ±‚é€šè¿‡ [å·¥ä½œæµ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è‡ªåŠ¨åˆ›å»ºï¼Œå°†ä»“åº“ä¸­çš„ LICENSE æ–‡ä»¶æ›´æ–°è‡³ç‰ˆæœ¬ ${{ env.LICENSE_VERSION }}ã€‚<br>åœ¨åˆå¹¶å‰è¯·ä»”ç»†æ£€æŸ¥ã€‚" --base main --head "LICENSE-${{ env.LICENSE_VERSION }}" --label "DEV-å¼€å‘åˆ†æ”¯åˆå¹¶,DEV-éœ€è¦æ³¨æ„,å†…éƒ¨ä»»åŠ¡" --reviewer "Luna-Grace,DuckDuckStudio"
