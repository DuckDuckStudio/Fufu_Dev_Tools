name: åŒæ­¥ä¸»ä»“åº“çš„ LICENSE æ–‡ä»¶

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡

  # ç›‘å¬ä¸»ä»“åº“ä¸­ LICENSE æ–‡ä»¶çš„å˜åŒ–
  #repository_dispatch:
  #  types: [license-update]

jobs:
  sync_license:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºå¼€å‘å·¥å…·ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: è·å– LICENSE æ–‡ä»¶
        run: |
          # å…‹éš†ä¸»ä»“åº“å¹¶è·å– LICENSE æ–‡ä»¶
          git clone --branch main https://github.com/DuckDuckStudio/Fufu_Tools.git Fufu_Tools
          cp Fufu_Tools/LICENSE . # å°†ä¸»ä»“åº“çš„è®¸å¯æ–‡ä»¶æ‹·è´åˆ°å½“å‰ä»“åº“æ›¿æ¢æ—§çš„è®¸å¯æ–‡ä»¶

      - name: æ¯”è¾ƒ LICENSE æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°
        run: |
          # æ¯”è¾ƒå½“å‰ä»“åº“å’Œä¸»ä»“åº“çš„ LICENSE æ–‡ä»¶æ˜¯å¦ç›¸åŒ
          if cmp -s LICENSE Fufu_Tools/LICENSE; then
            echo "ğŸ‰ å½“å‰ä»“åº“ä¸­çš„è®¸å¯æ–‡ä»¶å·²ç»æœ€æ–°ï¼Œæ— éœ€æ›´æ–°ã€‚"
            echo "up-to-date=true" >> $GITHUB_ENV
          else
            echo "[WARNING] å½“å‰ä»“åº“ä¸­çš„è®¸å¯æ–‡ä»¶å·²ç»è¿‡æ—¶ï¼Œéœ€è¦æ›´æ–°ã€‚"
            echo "up-to-date=false" >> $GITHUB_ENV

      - name: è·å–æ–°çš„ LICENSE æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·
        if: env.up-to-date == 'false'
        run: |
          # ä» LICENSE æ–‡ä»¶ä¸­è·å–ç‰ˆæœ¬å·ï¼Œå‡è®¾ç‰ˆæœ¬å·åœ¨æ–‡ä»¶çš„ç¬¬äºŒè¡Œ
          version=$(awk 'NR==2 {print \$2}' LICENSE)  # è·å– LICENSE æ–‡ä»¶ç¬¬äºŒè¡Œçš„ç‰ˆæœ¬å·
          echo "LICENSE_VERSION=${version}" >> $GITHUB_ENV  # å°†ç‰ˆæœ¬å·ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¸­

      - name: æ¨é€ä¿®æ”¹
        if: env.up-to-date == 'false'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git checkout -b "LICENSE-${{ env.LICENSE_VERSION }}"

          git add LICENSE
          git commit -m "[Auto] æ›´æ–°è®¸å¯æ–‡ä»¶è‡³ç‰ˆæœ¬ ${version}"

          git push origin "LICENSE-${{ env.LICENSE_VERSION }}"

      - name: åˆ›å»ºæ‹‰å–è¯·æ±‚
        if: env.up-to-date == 'false'
        env:
            GH_TOKEN: ${{ github.token }}
        run: |
          # åˆ›å»ºæ‹‰å–è¯·æ±‚
          gh pr create \
            --title "[Auto] æ›´æ–°è®¸å¯æ–‡ä»¶è‡³ç‰ˆæœ¬ ${{ env.LICENSE_VERSION }}" \
            --body "æ­¤æ‹‰å–è¯·æ±‚é€šè¿‡ [å·¥ä½œæµ](https://github.com/DuckDuckStudio/Fufu_Dev_Tools/actions/runs/${{ github.run_id }}) è‡ªåŠ¨åˆ›å»ºï¼Œå°†ä»“åº“ä¸­çš„ LICENSE æ–‡ä»¶æ›´æ–°è‡³ç‰ˆæœ¬ ${{ env.LICENSE_VERSION }}ã€‚<br>åœ¨åˆå¹¶å‰è¯·ä»”ç»†æ£€æŸ¥ã€‚" \
            --base main
            --head "LICENSE-${{ env.LICENSE_VERSION }}"
            --label "DEV-å¼€å‘åˆ†æ”¯åˆå¹¶, DEV-éœ€è¦æ³¨æ„, å†…éƒ¨ä»»åŠ¡" \
            --reviewer "Luna-Grace" \
            --reviewer "DuckDuckStudio"
